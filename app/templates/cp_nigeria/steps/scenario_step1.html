{% extends 'cp_nigeria/steps/step_progression.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load i18n %}

{% block head_block %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin=""
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" />
<link rel="stylesheet" href="{% static 'css/map.css' %}" type="text/css">
{% endblock head_block %}

{% block start_body_scripts %}
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==">
    </script>
{% endblock %}

{% block progression_content %}
    <div>
        </section>
        <section class="project-setup two-columns">
            <div class="left">
                <div>
                    <div class="text">
                  <span>
                    {% translate "Fill in the following parameters:" %}
                  </span>
                    </div>
                    <form method="post">
                        {% csrf_token %}

                        <div class="input-item">
                            {{ form.name| as_crispy_field }}
                        </div>
                        <div class="input-item">
                            {{ form.latitude|as_crispy_field }}
                        </div>
                        <div class="input-item">
                            {{ form.longitude|as_crispy_field }}
                        </div>
						<a class="btn btn--medium" type="button">{% translate "Fetch weather data from location" %}</a>
						<a class="btn btn--medium" type="button">
								{% translate "Upload weather data" %}
						</a>
                        <div class="input-item">
                            {{ form.duration|as_crispy_field }}
                        </div>
                        <div class="input-item">
                            {{ fig | safe }}
                        </div>
                    </form>
                </div>
            </div>
            <div class="right">
                <div>
                    <!-- Insert map -->
                    <div class="map" id="mapid">

                    </div>
                </div>
            </div>
        </section>
    </div>


        <script>
            /* Map Show and Latitude-Longitude data autofill */
            var mymap = L.map('mapid').setView([8.786469, 7.433806], 6);

            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox/streets-v11',
                tileSize: 512,
                zoomOffset: -1,
                accessToken: 'pk.eyJ1IjoidmFsa2FsYWlzIiwiYSI6ImNrZGhpZ29peTFnMjIycG5ybWR3aG4yeHIifQ.L4y4PQjkIdO1c7pvzOr2kw'
            }).addTo(mymap);

            var popup = L.popup();

            function onMapClick(e) {
                popup.setLatLng(e.latlng)
                    .setContent(`Location Coordinates: <br> (${e.latlng.lat.toFixed(4)}. ${e.latlng.lng.toFixed(4)})`).openOn(mymap);
                $('#id_latitude').val(e.latlng.lat.toFixed(6));
                $('#id_longitude').val(e.latlng.lng.toFixed(6));
                /*
                $.ajax({
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    type: "GET",
                    url: `https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat.toFixed(6)}&lon=${e.latlng.lng.toFixed(6)}`,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (resp) {
                        console.log(resp.address.country);
                        popup.setLatLng(e.latlng)
                        .setContent("Location " + resp.address.country + "<br> Coordinates:" + e.latlng.toString()).openOn(mymap);
                        //$('#id_country').val(resp.address.country);
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        const jsonData = XMLHttpRequest.responseJSON;
                        //Swal.fire('Country Error', `Could not retrieve country name.`, 'error');
                    }
                });
                */

            }

            mymap.on('click', onMapClick);
        </script>

    </div>
</div>


{% endblock %}