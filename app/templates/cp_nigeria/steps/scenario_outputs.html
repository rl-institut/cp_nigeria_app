{% extends 'cp_nigeria/steps/step_progression.html' %}
{% load crispy_forms_tags %}
{% load custom_filters %}
{% load humanize %}
{% load custom_template_tags %}
{% load i18n %}
{% load static %}

{% block head_block %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-bs/1.10.23/dataTables.bootstrap.min.css" integrity="sha512-Z+BWkkwxMpBhQthPeqw2UbG1tamgkRHi1UaYyZ8mTnjt04iXqeVx/Wu4CYzPOn3E+x663DIV+SiAuKDHbTg6FQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link href="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.css" rel="stylesheet">
<!--link href="{% static 'css/quick_fix.css' %}" rel="stylesheet" type="text/css" /-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">

{% endblock head_block %}

{% block start_body_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js" integrity="sha512-Y8iWYJDo6HiTo5xtml1g4QqHtl/PO1w+dmUpQfQSOTqKNsMhExfyPN2ncNAe9JuJUSKzwK/b6oaNPop4MXzkwg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.1.1/d3.min.js" integrity="sha512-COTaPOlz12cG4fSfcBsxZsjauBAyldqp+8FQUM/dZHm+ts/jR4AFoJhCqxy8K10Jrf3pojfsbq7fAPTb1XaVkg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript" src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="{% static 'js/traceplot.js' %}"></script>
<script src="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.20.0/plotly.min.js" integrity="sha512-tuzZby9zsxdCMgqKMHo+ObEWrfBTFlKZ7yIHSow5IYbr0JseLNTXm37NSn0rrWVbvKMfvGUCSm5L1sK9QGuLyw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% load static %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/tippy.js/2.5.4/tippy.all.min.js" integrity="sha512-9LKXH8DIeFSdiDIWQSOJNZuwLynJNm4x/1eBRpPfRJsEXZWJL+aoH+JNDglF3DcCoQYVBHqXo8sVHOLveoaN0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables.net/1.10.23/jquery.dataTables.min.js" integrity="sha512-coE8Qg+5Eb8e0xSXkdSJYln78NclTBgX6rducQWvi3NZooVaR1GVcVA5fRPVetzSqh9CEBv7hzwuQsZLLC0e8g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

{% endblock start_body_scripts %}

{% block title %}{% translate "Results" %}{% endblock title %}

{% block progression_content %}

<!-- Modal -->
<div class="modal fade modal--gui" id="guiModal" tabindex="-1" role="dialog" aria-labelledby="guiModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="guiModalLabel">New message</h5>
				<button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form>
				{% csrf_token %}
				<div class="modal-body"></div>
			</form>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Close" %}</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade modal--dashboard" id="KPIModal" tabindex="-1" aria-labelledby="KPIModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="KPIModalLabel">{% translate "KPI Overview" %}</h4>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<table class="table" id="kpiTable">
					<thead>
					<tr>
						<th scope="col">{% translate "Name" %}</th>
						<th scope="col">{% translate "Unit" %}</th>
						<th scope="col">{% translate "Definition" %}</th>
						<th scope="col"></th>
					</tr>
					</thead>
					<tbody>
					{% for kpi_id, kpi in kpi_list.items %}
					<tr>
						<td scope="row">{% translate kpi.verbose %}</td>
						<td>{% translate kpi.unit %}</td>
						<td>{% translate kpi.definition %}</td>
						<td><button class="btn btn--small btn--transparent">+ {% translate "Add to results" %}</button></td>
					</tr>
					{% endfor %}
					</tbody>
				</table>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn--medium" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>


{% include "modal_template.html" with id="createReportItemModal" modal_style_class="modal--dashboard" submit_btn_label="Create" title="Add a new report item" custom_submit_function="createReportItem(event)" %}

{% include "modal_template.html" with id="createSaGraphModal" modal_style_class="modal--dashboard" submit_btn_label="Create" title="Add a new report item" form=sa_graph_form %}

<!-- Modal to create sensitivity analysis -->
<div class="modal fade modal--dashboard" id="createSaGraphModal" tabindex="-1" role="dialog" aria-labelledby="createSaGraphModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="createSaGraphModalLabel">{% translate "Add a sensitivity analysisgraph" %}</h5>
				<button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form method="POST" action="{% url 'sensitivity_analysis_create_graph' proj_id %}" graph-parameter-url="{% url 'ajax_get_sensitivity_analysis_parameters' %}">
					{% csrf_token %}
					{{ sa_graph_form | crispy}}
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Close" %}</button>
				<button class="btn btn--medium" onclick="javascript:submitModalForm(event, modalId='createSaGraphModal')">{% translate "Create" %}</button>

			</div>
		</div>
	</div>
</div>

<main>
	<!--	<section class="header">-->
	<!--		<div>-->
	<!--			<div class="header__left"></div>-->
	<!--			<h1 class="header__title">{% translate "Simulation results" %}</h1>-->
	<!--			<div class="header__back">-->
	<!--				<a href="{% url 'back_to_scenario_review' proj_id %}">{% translate "To scenario" %}</a>-->
	<!--			</div>-->
	<!--		</div>-->
	<!--	</section>-->
	<!--	<section class="header-results">-->
	<!--		<div>-->
	<!--			<div class="header-results__scenario">-->
	<!--				<div class="project-title">-->
	<!--					{% translate "Project" %}-->
	<!--				</div>-->
	<!--				<div class="project-name">-->
	<!--					<form action="{% url 'result_change_project' %}" method="POST">-->
	<!--						{% csrf_token %}-->
	<!--						<select name="proj_id" class="form-select" aria-label="Default select example" onchange="this.form.submit()">-->
	<!--							{% for project in project_list %}-->
	<!--							<option value="{{ project.id }}" {% if project.id == proj_id %} selected {% endif %}> {{ project.label }} </option>-->
	<!--							{% endfor %}-->
	<!--						</select>-->
	<!--					</form>-->
	<!--				</div>-->
	<!--			</div>-->
	<!--			<div class="header-results__export">-->
	<!--				{% block export-results %}-->
	<!--				<a type="button" class="btn btn-small" href="{% url 'redirect_download_timeseries_results' proj_id %}"><span class="icon icon-export"></span>{% translate "Download Timeseries" %}</a>-->
	<!--				<a type="button" class="btn btn-small" href="{% url 'download_scalar_results' scen_id %}"><span class="icon icon-export"></span>{% translate "Download KPIs" %}</a>-->
	<!--				<a type="button" class="btn btn-small" href="{% url 'download_cost_results' scen_id %}"><span class="icon icon-export"></span>{% translate "Download Component Costs" %}</a>-->
	<!--				{% endblock export-results %}-->
	<!--			</div>-->
	<!--		</div>-->
	<!--	</section>-->


	<!-- insert tabs here, previous class result-selector -->
	<section>
		<!--		<div class=" dashboard-tabs">-->
		<!--			<div>-->
		<!--				<ul class="dashboard-tabs nav nav-tabs" id="results-analysis-links">-->
		<!--					<li class="nav-item">-->
		<!--						<a class="nav-link" id="single-scenario-link" href="{% url 'project_visualize_results' proj_id %}">{% translate "Single scenarios" %}</a>-->
		<!--					</li>-->
		<!--					<li class="nav-item">-->
		<!--						<a class="nav-link" id="compare-scenario-link" href="{% url 'project_compare_results' proj_id %}">{% translate "Compare scenarios" %}</a>-->
		<!--					</li>-->
		<!--					<li class="nav-item">-->
		<!--						<a class="nav-link" id="sensitivity-analysis-link" href="{% url 'project_sensitivity_analysis' proj_id %}">{% translate "Sensitivity Analysis" %}</a>-->
		<!--					</li>-->
		<!--				</ul>-->
		<!--			</div>-->
		<!--		</div>-->
		<div class="tab-content" id="js-db-top-section">
			<!--<div class="dashboard-options sticky-top">-->
			<!--	<div>-->
			<!--		<div class="row">-->
			<!--			<div class="dashboard__scenarios">-->
			<!--				<div class="dashboard__select-scenarios dashboard__select-scenarios&#45;&#45;small">-->
			<!--					<label for="results-scenarios" class="form-label">{% translate "Scenario" %}</label>-->
			<!--					<select name="results-single-scenario" id="results-scenarios" placeholder="This is a placeholder" onchange="update_selected_single_scenario(this.value)">-->
			<!--						{% for scenario in scenario_list %}-->
			<!--						<option value="scenario-{{ proj_id }}-{{ scenario.id}}" {% if scenario.id == scen_id %} selected {% endif %} >{{ scenario.name }}</option>-->
			<!--						{% empty %}-->
			<!--						{% translate "You have no scenario with completed simulation, please run simulations to display results" %}-->
			<!--						{% endfor %}-->
			<!--					</select>-->
			<!--				</div>-->
			<!--				{% if scenario_list %}-->
			<!--				<div class="dashboard__add">-->
			<!--					<button class="btn btn&#45;&#45;small btn&#45;&#45;transparent" type="submit" onclick="javascript:showCreateReportItemModal(event)">-->
			<!--						<span class="icon icon-add"></span>-->
			<!--						{% translate "Add chart" %}-->
			<!--					</button>-->
			<!--				</div>-->
			<!--				{% endif %}-->
			<!--			</div>-->
			<!--		</div>-->
			<!--	</div>-->
			<!--</div>-->
			<div>
				<a href="{% url 'cpn_steps' proj_id step_id %}">Back to simple output version</a>
			</div>
			<div class="dashboard">
				<div>
					<div class="header-results">
						<button class="title" onclick="collapseTables()">{% translate "Collapse all tables" %}</button>
					</div>
					<div class="header-results">
						<h2 class="title">{% translate "Overview" %}</h2>
					</div>
					<div class="row">
						<div class="col col-md-12">
							<div class="chart">
								<div class="chart__header">
									<!-- style="display: flex;gap: 10px;align-items: center;" -->
									<div>
										<span class="title">{% translate "Schematic" %}</span> <a href="{% url 'scenario_visualize_results' scen_id %}">open_plan results</a>
									</div>
								</div>

								<div class="chart__plot">
									<div style="display:flex;justify-content:center;align-content:center;">
										{% if es_schema_name %}
										<img class="img" src="{% static 'assets/gui/' %}{{ es_schema_name }}" alt="example_es" style="width:400px;">
										{% endif %}
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col col-md-12">
							<div class="chart">
								<div class="chart__header">
									<!-- style="display: flex;gap: 10px;align-items: center;" -->
									<div>
										<span class="title">{% translate "Financial KPIs" %}</span>
									</div>
								</div>

								<div class="chart__plot">
									<table class="table">
										<thead><tr><th>Description</th><th>Value</th></tr></thead>
										<tr>
											<td>Tariff:</td>
											<td>{{ tariff_NGN | floatformat | intcomma}} {{ currency_symbol }} ({{ tariff_USD | floatformat:3 | intcomma}} USD) </td>
										</tr>
										{% for kpi, value in financial_kpis.items %}
										<tr>
											<td>{{ kpi | safe }}</td>
											<td>{{ value | floatformat | intcomma}} {{ currency_symbol }} </td>
										</tr>
										{% endfor %}
									</table>
								</div>
							</div>
						</div>
					</div>


					{% include "report/graph_template.html" with id="cash_flow" title="Cash flow breakdown" %}
					{% include "report/graph_template.html" with id="revenue" title="Operating revenues" %}
					{% include "report/graph_template.html" with id="capex" title="Investment costs" %}

					<div class="header-results">
						<h2 class="title">{% translate "Assumption CAPEX" %}</h2>
					</div>
					{% for cat, df in capex_assumptions.items %}
					{% include "report/table_template.html" with id="Table"|add:cat title=cat df=df %}
					{% endfor %}

					<div class="header-results">
						<h2 class="title">{% translate "Cash Flow Calculation" %}</h2>
					</div>
					{% include "report/table_template.html" with id="TableRevenue" title="Revenue" df=revenue_flows %}
					{% include "report/table_template.html" with id="TableOpex" title="Opex" df=opex_costs %}
					{% include "report/table_template.html" with id="TableLosses" title="Losses" df=losses %}

					{% include "report/table_template.html" with id="TableCashFlow" title="CashFlow" df=cash_flow %}

					<div class="header-results">
						<h2 class="title">{% translate "Senior Debt Service" %}</h2>
					</div>
					{% include "report/table_template.html" with id="TableSeniorDebt" title="Senior Debt" df=senior_debt %}
					{% include "report/table_template.html" with id="TableReplacementDebt" title="Replacement Debt" df=replacement_debt %}


					<div class="row">
						<div class="col col-md-12">
							<div class="chart">
								<div class="chart__header">
									<!-- style="display: flex;gap: 10px;align-items: center;" -->
									<div>
										<span class="title">{% translate "Business model" %}</span>
									</div>
								</div>
								<div class="chart__plot">
									{{ model_graph}}
									<div style="display:flex;justify-content:center;align-content:center;">
										<img class="img" src="{% static 'assets/cp_nigeria/business_models/' %}{{model_image}}" alt="example_es" style="width:400px;">
									</div>
									<div style="padding-left:5rem;padding-right:5rem;padding-bottom:2rem;padding-top:3rem;">
										<p><h3> Model chosen: {{model_name}}</h3></p>
										{{ model_description}}
									</div>
								</div>
							</div>
							<div style="display:flex;justify-content:center">
								<button class="btn btn--medium"  onclick="javascript:downloadReport({{ proj_id }})" style="margin-top:0.5rem">
									Download report (dev_info:ajax call)
								</button>
							</div>
						</div>
					</div>


					<div class="header-results">
						<h2 class="title">{% translate "Technoeconomic parameters" %}</h2>
					</div>
					<div class="row">
						<div class="col col-md-12">
							<div class="chart">
								{% include "report/table_template.html" with id="TableFirstYear" title="Power supply system costs in first year" df=system_costs %}
							</div>

						</div>

					</div>
					{% include "report/graph_template.html" with id="costs" title="Overall costs breakdown" %}

					<div class="row">
						<div class="col col-md-12">
							<div class="chart">
								{% include "report/table_template.html" with id="CommunitySummary" title="Community demand summary" df=cgs_df %}
							</div>
						</div>
					</div>
					{% if scenario_list %}
					<!-- KPI table start -->
					<div class="col" id="report_items" style="display:flex;flex-direction:column;">
						<div class="header-results">
							<h2 class="title">{% translate "Energy System" %}</h2>
						</div>

						{% include "report/kpis_template.html" with table_styles=table_styles %}
						<!-- KPI table end -->
						<!-- ES design start -->

						<div class="row">
							<div class="col col-md-12">
								<div class="chart">
									<div class="chart__header">
										<!-- style="display: flex;gap: 10px;align-items: center;" -->
										<div>
											<span class="title">{% translate "System size" %}</span>
										</div>
									</div>
									<div class="chart__plot">
										<table class="table" id="selectedKPITable">
											<thead><tr><th>Asset</th><th>Size</th></thead>
											<tbody id="General">

											</tbody>
											{% for cap in capacities %}
											<tr>
												<td>{{ cap.asset }}</td>
												<td>{{ cap.optimized_capacity | floatformat | intcomma }} {{ cap.unit }}</td>
											</tr>
											{% endfor %}
										</table>
									</div>
								</div>
								{% include "report/graph_template.html" with id="capacities" title="Installed and optimized capacities" %}
							</div>

						</div>
						<div class="row">
							<div class="col col-md-12">
								<div class="chart">
									<div class="chart__header">
										<!-- style="display: flex;gap: 10px;align-items: center;" -->
										<div>
											<span class="title">{% translate "Total flows" %}</span>
										</div>
									</div>
									<div class="chart__plot">
										<table class="table" id="totalFlowsTable">
											<thead><tr><th>Asset</th><th>Total Supply (year)</th><th>Excess generation (year)</th></tr></thead>
											<tbody>

											</tbody>
											{% for cap in capacities %}
											{% if cap.asset == 'inverter' or cap.asset == 'diesel_generator' %}
											<tr>
												{% if cap.asset == 'inverter' %}
												<td>{% if 'B' in es_schema_name %} Solar PV + Battery {% else %} Solar PV {% endif %}</td>
												{% else %}
												<td>Diesel generator</td>
												{% endif %}
												<td>{{ cap.total_supply | floatformat | intcomma }} kWh </td>
												<td>{{ excess|get_item:cap.asset | floatformat | intcomma }} kWh </td>
											</tr>
											{% endif %}
											{% endfor %}
										</table>
									</div>
								</div>

								{% include "report/graph_template.html" with id="cpn_stacked_timeseries" title="Stacked timeseries" %}
								{% include "report/graph_template.html" with id="sankey" title="Sankey diagram" %}
							</div>

						</div>

						<!-- Graphs area  stop -->
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</section>


</main>
{% endblock progression_content %}


{% block end_body_scripts %}



{{ report_items_data|json_script:"existingReportItemsData" }}

<script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.serializeJSON/3.1.0/jquery.serializejson.min.js"
		integrity="sha512-4y8bsEzrXJqRyl2dqjdKk/DetH59JcFTtYNMsy5DUpvVV8CXiSrQ1gSCL3+dFgj1Xco0ONPizsYd6wX2eAXL2g=="
		crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
const urlNotImplemented = `{% url 'not_implemented' %}?url={{ request.get_full_path }}`;
const urlCopyReportItem = "#";
const urlDeleteReportItem = `{% url 'report_delete_item' proj_id %}`;
const urlSaveToDB = `{% url 'save_graph_to_db' proj_id %}`;
const saveToDB = {% if save_to_db %} true {% else %} false {% endif %};
const urlDownloadReport = `{% url 'ajax_download_report' %}`;
</script>
<script src="{% static 'js/report_items.js' %}"></script>


{% if multiple_scenario_selection %}
<script> const multipleScenarioSelection = true;  </script>
{% else %}
<script>const multipleScenarioSelection = false;</script>
{% endif %}



<script>

	function update_kpi_table_style(scen_id=""){

        $.ajax({
            url: "{% url 'cpn_kpi_results' proj_id=proj_id %}",
            type: "GET",
            success: async (table_data) => {

            const parentDiv = document.getElementById("selectedKPITable");
            parentDiv.innerHTML = "";


            /* create KPI table headers */
            const tableHead = document.createElement('thead');
            const table_headers = table_data.hdrs; // todo add dynamically more scenarios here
            const table_length = table_headers.length;
            const tableHeadContent = document.createElement('tr');
            table_headers.map(hdr =>
                {
                    var tableHdr = document.createElement('th');
                    tableHdr.innerHTML = `{% blocktranslate %}` + hdr + `{% endblocktranslate %}`;
                    tableHeadContent.appendChild(tableHdr);
                }
            );
            tableHead.appendChild(tableHeadContent)
            parentDiv.appendChild(tableHead);


            for(subBody in table_data.data) {
                var tableBody = document.createElement('tbody');
                tableBody.id = subBody;
                /* add subtable title */
                const tableSubSectionTitleRow = document.createElement('tr');
                var tableSubSectionTitle = document.createElement('th');
                tableSubSectionTitle.innerHTML = subBody;
                tableSubSectionTitleRow.appendChild(tableSubSectionTitle);
                for(i=0;i<table_length-1;++i){
                    tableSubSectionTitleRow.appendChild(document.createElement('td'));
                }

                //tableBody.appendChild(tableSubSectionTitle);

                /* add subtable lines for each parameter */
                // (param should be a json object) with keys name (type str), unit type (str) and scen_values
                table_data.data[subBody].map(param =>{
                    var tableSubSectionParamRow = document.createElement('tr');
                    var cell = tableSubSectionParamRow.insertCell(0);
                    cell.innerHTML = `{% blocktranslate %}` + param.name +`{% endblocktranslate %} (` + param.unit +  `) <a data-bs-toggle="tooltip" title="" data-bs-original-title="${param.description}" data-bs-placement="right"><img style="height: 1.2rem;margin-left:.5rem" alt="info icon" src="{% static 'assets/icons/i_info.svg'%}"></a>`;
                    //cell.setAttribute("title", param.description)
                    //cell.append(" just to see");
                    // todo for loop over scenario values
                    for(i=0;i<param.scen_values.length;++i){
                        cell = tableSubSectionParamRow.insertCell(1 + i);
                        cell.innerHTML = param.scen_values[i]
                    };
                    tableBody.appendChild(tableSubSectionParamRow);
                });


                parentDiv.appendChild(tableBody);
            }
            $('[data-bs-toggle="tooltip"]').tooltip()

            },
            /*error: function (xhr, errmsg) {
                console.log("backend_error!")
                //Show the error message
                $('#message-div').html("<div class='alert-error'>" +
                    "<strong>Success: </strong> We have encountered an error: " + errmsg + "</div>");
            }*/
        });

    };

    /* loop over scenario selection buttons and return the ids of the selected ones */
    // function fetchSelectedScenarios(){
    //     var selectedScenarios = [];
    //     var scenariosDropDown = $("#results-scenarios");
    //     if(scenariosDropDown){
    // 			if(Array.isArray(scenariosDropDown.val()) == false){
    // 				selectedScenarios.push(scenariosDropDown.val().split("-")[2]);
    // 			}
    // 			else{
    // 				selectedScenarios = scenariosDropDown.val();
    // 			};
    //     };
    //     return selectedScenarios;
    // };



    function scenario_visualize_timeseries(scen_id=""){
     $.ajax({
                url: "{% url 'scenario_visualize_timeseries' proj_id=proj_id %}" + scen_id,
                type: "GET",
                success: async (parameters) => {
                    await graph_type_mapping[parameters.type](parameters.id, parameters);
                }
            });
    };

    function scenario_visualize_stacked_timeseries(scen_id){
        $.ajax({
            url: "{% url 'scenario_visualize_stacked_timeseries'%}" +  scen_id,
            type: "GET",
            success: async (graphs) => {
                const parentDiv = document.getElementById("stacked_timeseries");
                await graphs.map(parameters => {
                    if(parameters.id != "Gas") {
                        const newGraph = document.createElement('div');
                        newGraph.id = "stacked_timeseries" + parameters.id;
                        parentDiv.appendChild(newGraph);
                        graph_type_mapping[parameters.type](newGraph.id, parameters);
                        // TODO change plotly title here
                    }
                });
            },
        });
    };

    function scenario_visualize_cpn_stacked_timeseries(scen_id){
        $.ajax({
            url: "{% url 'scenario_visualize_cpn_stacked_timeseries'%}" +  scen_id,
            type: "GET",
            success: async (graphs) => {
                const parentDiv = document.getElementById("cpn_stacked_timeseries");
                await graphs.map(parameters => {
                    if(parameters.id != "Gas") {
                        console.log(parameters)
                        const newGraph = document.createElement('div');
                        newGraph.id = "cpn_stacked_timeseries" + parameters.id;
                        parentDiv.appendChild(newGraph);
                        graph_type_mapping[parameters.type](newGraph.id, parameters);
                        // TODO change plotly title here
                    }
                });
            },
        });
    };


    function scenario_visualize_sankey(scen_id){
     $.ajax({
                url: "{% url 'scenario_visualize_sankey' %}" + scen_id,
                type: "GET",
                success: async (parameters) => {
                    await graph_type_mapping[parameters.type](parameters.id, parameters);
                },
            });
    };

    function scenario_visualize_capacities(scen_id=""){
     $.ajax({
                url: "{% url 'scenario_visualize_capacities' proj_id=proj_id %}" + scen_id,
                type: "GET",
                success: async (parameters) => {
                    await graph_type_mapping[parameters.type](parameters.id, parameters);;
                },
            });
    };

    function scenario_visualize_costs(scen_id=""){
     $.ajax({
                url: "{% url 'scenario_visualize_costs' proj_id=proj_id %}" + scen_id,
                type: "GET",
                success: async (graphs) => {
                                    const parentDiv = document.getElementById("costs");
                    await graphs.map(parameters => {
                        const newGraph = document.createElement('div');
                        newGraph.id = "costs" + parameters.id;
                        parentDiv.appendChild(newGraph);
                        if(parameters.title === "var1" || parameters.title === "var2")
                                { graph_type= parameters.type;
                                    parameters.title = "";}
                                else{ graph_type = parameters.type + "Scenarios";}
                        graph_type_mapping[graph_type](newGraph.id, parameters);
                    });
                },
            });
    };

    function scenario_visualize_cash_flow(scen_id=""){
     $.ajax({
                url: "{% url 'scenario_visualize_cash_flow' %}" + scen_id,
                type: "GET",
                success: async (parameters) => {
                    await addFinancialPlot(parameters, plot_id="cash_flow");
                },
            });
    };

    function scenario_visualize_revenue(scen_id=""){
     $.ajax({
                url: "{% url 'scenario_visualize_revenue' %}" + scen_id,
                type: "GET",
                success: async (parameters) => {
                    await addFinancialPlot(parameters, plot_id="revenue");
                },
            });
    };

	function scenario_visualize_capex(scen_id=""){
     $.ajax({
                url: "{% url 'scenario_visualize_capex' %}" + scen_id,
                type: "GET",
                success: async (parameters) => {
                    await addPieChart(parameters, plot_id="capex");
                },
            });
    };

</script>


<script src="{% static 'js/modal_utils.js' %}"></script>

<script>
	/** Add a new report item **/

    var createReportItemModalDOM = document.getElementById("createReportItemModal");
    var createReportItemModal = new bootstrap.Modal(createReportItemModalDOM);
    var createReportItemForm = createReportItemModalDOM.querySelector("form");
    var reportItemTitleDOM = createReportItemForm.querySelector('input[id="id_title"]');
    var reportItemTitle = ''
    var reportItemScenariosDOM = createReportItemForm.querySelector('input[id="id_scenarios"]');
    var reportItemScenarios = [];


    function updateReportItemParametersForm(graphType){
        // Passes the existing text of the title to the form initials
        reportItemTitleDOM = createReportItemForm.querySelector('input[id="id_title"]');
        if(reportItemTitleDOM){
            reportItemTitle = reportItemTitleDOM.value
        }
        // Passes the preselected scenarios to the form initials
        reportItemScenariosDOM = createReportItemForm.querySelector('select[id="id_scenarios"]');
        if(reportItemScenariosDOM){
            reportItemScenarios = [];
            Array.from(reportItemScenariosDOM.querySelectorAll('option:checked')).forEach(item => {
                reportItemScenarios.push(item.value);
            });
        }
        else{
            reportItemScenarios = fetchSelectedScenarios();
        }

        var urlForm = createReportItemForm.getAttribute("graph-parameter-url");

        $.ajax({
            url: urlForm,
            type: "POST",
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            data: {
              'title': reportItemTitle,
              'report_type': graphType,
              'selected_scenarios': JSON.stringify(reportItemScenarios),
              'multi_scenario': multipleScenarioSelection
            },
            success: function (formData) {
               // find and keep the csrf token of the form
               var csrfToken = createReportItemForm.querySelector('input[name="csrfmiddlewaretoken"]');

                console.log(formData)

               // update the report item graph
               createReportItemForm.innerHTML = csrfToken.outerHTML + formData;

               // (re)link the changing of report_item type combobox to loading new parameters form
               // the name of the id is linked with the name of the attribute of ReportItem model in dashboard/models.py
               $("#id_report_type").change(function (event) {
                    var reportItemType = $(this).val();
                    updateReportItemParametersForm(reportItemType)
               })
               $("#id_scenarios").change(function (event) {
                    var reportItemType = $("#id_report_type").val();
                    updateReportItemParametersForm(reportItemType)
               })
            }
        });
    };

    function showCreateReportItemModal(event){
        showModal(
            event,
            modalId="createReportItemModal",
            attrs={
                enctype: "multipart/form-data",
                "ajax-post-url": `{% url 'report_create_item' proj_id %}`,
                "graph-parameter-url": `{% url 'ajax_get_graph_parameters_form' proj_id %}`
            }
        )
        updateReportItemParametersForm("timeseries")
        //createReportItemModal.show()

    }


document.querySelectorAll("#results-analysis-links a").forEach(el => {el.classList.remove("active")});
</script>

{% block results_end_body_scripts %}
<script>

	// var dropdownElement = new Choices('#results-scenarios', {
    // 	allowHTML: false,
    // 	itemSelectText: '',
    // });

    $(document).ready(function () {
        // add search field to the kpi info modal
        $('#kpiTable').DataTable();
        const scen_id = "{{ scen_id }}";
        const proj_id = "{{ proj_id }}";
        // update the kpi table
        update_kpi_table_style(scen_id);
        //scenario_visualize_timeseries(scen_id);
        //scenario_visualize_stacked_timeseries(scen_id);
        scenario_visualize_cpn_stacked_timeseries(scen_id);
        scenario_visualize_sankey(scen_id);
        scenario_visualize_capacities(scen_id);
        scenario_visualize_costs(scen_id);
        scenario_visualize_cash_flow(scen_id);
        scenario_visualize_revenue(scen_id);
        scenario_visualize_capex(scen_id);
        // Highlight only the selected scenario
        //$(".scenario-select__item").map((i, item) => {item.classList.remove("selected");});
        // todo select the correct_scenario
        //document.getElementById("scenario-" + proj_id + "-" + scen_id).classList.add("selected");
    });

    function update_selected_single_scenario(target){
        const proj_id = target.split("-")[1];
        const scen_id = target.split("-")[2];

        // call the list and the success should then call other function which collect the data in the session's cache and plot it(session cache should use mvs tokens to know if a simulation was updated or not)
        if(scen_id != null){

            $.ajax({
                url: "{% url 'update_selected_single_scenario' proj_id %}" + scen_id,
                type: "GET",
                success: async (data) => {

                    /* Update the kpi table */
                    update_kpi_table_style(scen_id);

                    scenario_visualize_timeseries(scen_id);
                    // scenario_visualize_stacked_timeseries(scen_id);
                    scenario_visualize_cpn_stacked_timeseries(scen_id);
                    scenario_visualize_sankey(scen_id);
                    scenario_visualize_capacities(scen_id);
                    scenario_visualize_costs(scen_id);
                },
                error: function (xhr, errmsg) {
                    if (xhr.status != 405){
                        console.log("backend_error!")
                        //Show the error message
                        $('#message-div').html("<div class='alert-error'>" +
                            "<strong>Success: </strong> We have encountered an error: " + errmsg + "</div>");
                    }
                }
            });
        }
    }
</script>

{% if scen_id > 0 %}
<script>
	const csrfToken = '{{ csrf_token }}';
    const formGetUrl = `{% url 'view_asset_parameters' scen_id %}`;
    const formPostUrl = "";
    const scenarioBelongsToUser = {% if scenario.project.user == request.user %}true{% else %}false{% endif %};
</script>
<script src="{% static 'js/report_items.js' %}"></script>

<script>

	//     /* First retrieve the busses and assets, then draw the links */
    //     $(window).on('load', async function () {
    //         const data = JSON.parse(`{{topology_data_list| escapejs }}`);
    //         Promise.all([addBusses(data['busses']), addAssets(data['assets'])])
    //             .then(async () => addLinks(data['links']))
    //             .catch(err=>Swal.fire('Grid Model Error', 'Could not retrieve grid nodes.', 'error'));
    //     });
        //
    //     // assign double click on the energy system area
    //     document.querySelector('.drawflow').addEventListener("dblclick", function (e) {
        //
    //         const closestNode = e.target.closest('.drawflow-node');
    //         const nodeType = closestNode.querySelector('.box').getAttribute(ASSET_TYPE_NAME);
        //
    //         if (closestNode) {
    //             const topologyNodeId = closestNode.id;
    //             // formGetUrl is defined above
    //             const getUrl = formGetUrl + nodeType +
    //                 (nodesToDB.has(topologyNodeId) ? "/" + nodesToDB.get(topologyNodeId).uid : "");
        //
    //             // get the form of the asset of the type "nodeType" (dashboard/views.py::view_asset_parameters)
    //             fetch(getUrl)
    //             .then(formContent=>formContent.text())
    //             .then(formContent=> {
    //                 // assign the content of the form to the form tag of the modal
    //                 guiModalDOM.querySelector('form .modal-body').innerHTML = formContent;
        //
    //                 // set parameters which uniquely identify the asset
    //                 guiModalDOM.setAttribute("data-node-type", nodeType);
    //                 guiModalDOM.setAttribute("data-node-topo-id", topologyNodeId);
    //                 guiModalDOM.setAttribute("data-node-df-id", topologyNodeId.split("-").pop());
    //                 editor.editor_mode = "fixed";
        //
    //                 updateInputTimeseries();
        //
    //                 //update the graph of the flow timeseries, if any
    //                 ts_data_div = document.getElementById("flow_data");
    //                 if(ts_data_div){
    //                     var ts_data = JSON.parse(ts_data_div.querySelector("textarea").value);
    //                     if(["bess", "h2ess", "gess", "hess"].includes(nodeType)){
    //                         //storage asset
        //
    //                         storageResultGraph(ts_data.timestamps, ts_data.traces, plot_id="flow_trace",userLayout={hovermode:'x unified'})
    //                     }
    //                     else if(["dso", "dso_gas"].includes(nodeType)){
    //                         console.log("Hihihi")
    //                         plotTimeseries(ts_data.timestamps, ts_data.traces, plot_id="flow_trace",userLayout={hovermode:'x unified'})
    //                     }
    //                     else if(["heat_pump","chp", "chp_fixed_ratio"].includes(nodeType)){
    //                         plotTimeseries(ts_data.timestamps, ts_data.traces, plot_id="flow_trace",userLayout={hovermode:'x unified'})
    //                     }
    //                     else{
    //                         // all other assets
        //
    //                         var plotLayout = {
    //                             "yaxis": {"title": { "text": "Energy flow" }},
    //                         };
    //                         if (ts_data.traces.length > 1){
    //                         	plotLayout["hovermode"]='x unified'
    //                         };
    //                         plotTimeseries(ts_data.timestamps, ts_data.traces, plot_id="flow_trace", userLayout=plotLayout)
    //                     }
    //                 }
        //
    //                 guiModal.show()
    //                 $('[data-bs-toggle="tooltip"]').tooltip()
        //
    //             })
    //         }
    // });


</script>
{% endif %}
{% endblock results_end_body_scripts %}

{% endblock end_body_scripts %}
